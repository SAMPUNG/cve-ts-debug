import { player } from '@cve-ts/player'

import {
  hideOverlay,
  resetAfkWarningTimer,
  setOverlay,
  startAfkWarningTimer,
} from '../core/afk'
import {
  createOnScreenKeyboardHelpers,
  invalidateFreezeFrameOverlay,
  onDataChannelMessage,
  resizeFreezeFrameOverlay,
  setupFreezeFrameOverlay,
  showFreezeFrameOverlay,
  showPlayOverlay,
} from '../core/freeze'
import { setFrameDisplayDeltaTime } from '../core/latency'
import refs from '../refs/instance'
import {
  aggregateStats,
  clear,
  updateReceiveToCompositeMs,
} from '../core/stats'

import type { CveDebugDetail } from '@cve-ts/player'

function onAFK(detail: string) {
  switch (detail) {
    case 'reset': {
      resetAfkWarningTimer()
      break
    }
    case 'start': {
      startAfkWarningTimer()
      break
    }
    default: {
    }
  }
}

function onPlay(detail: string) {
  switch (detail) {
    case 'start': {
      hideOverlay()
      showFreezeFrameOverlay()
      break
    }
    case 'error': {
      showPlayOverlay()
      break
    }
    default: {
    }
  }
}

function onSetup(detail: string) {
  switch (detail) {
    case 'config': {
      createOnScreenKeyboardHelpers()
      break
    }
    case 'freeze': {
      resizeFreezeFrameOverlay()
      break
    }
    default: {
    }
  }
}

function onStart(detail: boolean) {
  if (!player) {
    return
  }

  const visible = true
  const classList = refs['cve-player-debug-panel'].classList
  classList.toggle('overlay-collapse', !visible)

  setupFreezeFrameOverlay()

  refs['quality-status'].className = 'grey-status'
  refs['stats'].textContent = 'Not connected'

  // Is Reconnection
  if (detail) {
    startAfkWarningTimer()
    invalidateFreezeFrameOverlay()
  }
}

function onText(detail: string) {
  const textOverlay = document.createElement('div')
  textOverlay.id = 'message-overlay'
  textOverlay.innerHTML = detail || ''
  setOverlay('text-display-state', textOverlay)
}

export function setupListeners() {
  if (!player) {
    return
  }

  player.addEventListener('debug', (evt) => {
    const detail = evt.detail as Partial<CveDebugDetail>

    if(detail.afk) {
      onAFK(detail.afk)
    }

    if(detail.composite) {
      updateReceiveToCompositeMs(detail.composite)
    }

    if(detail.kick) {
      refs['kick-other-players-button'].value = `Kick (${detail.kick})`
    }

    if(detail.latency) {
      setFrameDisplayDeltaTime(detail.latency)
    }

    if(detail.message) {
      onDataChannelMessage(detail.message)
    }

    if(detail.play) {
      onPlay(detail.play)
    }

    if(detail.setup) {
      onSetup(detail.setup)
    }

    if(detail.start) {
      onStart(detail.start)
    }

    if(detail.stats) {
      aggregateStats(detail.stats)
    }

    if(detail.text) {
      onText(detail.text)
    }
  })

  player.addEventListener('disconnected', () => {
    clear()
  })
}
