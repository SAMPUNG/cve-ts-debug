import { player } from '@cve-ts/player'

import {
  hideOverlay,
  resetAfkWarningTimer,
  setOverlay,
  startAfkWarningTimer,
} from '../core/afk'
import {
  createOnScreenKeyboardHelpers,
  invalidateFreezeFrameOverlay,
  onDataChannelMessage,
  resizeFreezeFrameOverlay,
  setupFreezeFrameOverlay,
  showFreezeFrameOverlay,
  showPlayOverlay,
} from '../core/freeze'
import { setFrameDisplayDeltaTime } from '../core/latency'
import refs from '../refs/instance'
import {
  aggregateStats,
  clear,
  updateReceiveToCompositeMs,
} from '../core/stats'

function onPlay(evt: CustomEvent<string>) {
  switch (evt.detail) {
    case 'start': {
      hideOverlay()
      showFreezeFrameOverlay()
      break
    }
    case 'error': {
      showPlayOverlay()
      break
    }
    default: {
    }
  }
}

function onAFK(evt: CustomEvent<string>) {
  switch (evt.detail) {
    case 'reset': {
      resetAfkWarningTimer()
      break
    }
    case 'start': {
      startAfkWarningTimer()
      break
    }
    default: {
    }
  }
}

function onSetup(evt: CustomEvent<string>) {
  switch (evt.detail) {
    case 'config': {
      createOnScreenKeyboardHelpers()
      break
    }
    case 'freeze': {
      resizeFreezeFrameOverlay()
      break
    }
    default: {
    }
  }
}

function onStart(evt: CustomEvent<boolean>) {
  if (!player) {
    return
  }

  // const visible = player.getBooleanAttribute('debug-panel')
  const visible = true
  const classList = refs['cve-player-debug-panel'].classList
  classList.toggle('overlay-collapse', !visible)

  setupFreezeFrameOverlay()

  refs['quality-status'].className = 'grey-status'
  refs['stats'].textContent = 'Not connected'

  // Is Reconnection
  if (evt.detail) {
    startAfkWarningTimer()
    invalidateFreezeFrameOverlay()
  }
}

function onText(evt: CustomEvent<string>) {
  const textOverlay = document.createElement('div')
  textOverlay.id = 'message-overlay'
  textOverlay.innerHTML = evt.detail || ''
  setOverlay('text-display-state', textOverlay)

  console.log(evt.detail)
}

export function setupListeners() {
  if (!player) {
    return
  }
  player.addEventListener('afk', (evt) => {
    // console.log('[debug] afk ===> ', evt.detail)
    onAFK(evt)
  })
  player.addEventListener('composite', (evt) => {
    // console.log('[debug] composite', evt.detail)
    updateReceiveToCompositeMs(evt.detail)
  })
  player.addEventListener('disconnected', () => {
    console.log('[debug] disconnected')
    clear()
  })
  player.addEventListener('kick', (evt) => {
    console.log('[debug] kick ===> ', evt.detail)
    refs['kick-other-players-button'].value = `Kick (${evt.detail})`
  })
  player.addEventListener('latency', (evt) => {
    console.log('[debug] latency ===> ', evt.detail)
    setFrameDisplayDeltaTime(evt.detail)
  })
  player.addEventListener('message', (evt) => {
    // console.log('[debug] message ===> ', evt.detail)
    onDataChannelMessage(evt.detail)
  })
  player.addEventListener('play', (evt) => {
    console.log('[debug] play ===> ', evt.detail)
    onPlay(evt)
  })
  player.addEventListener('start', (evt) => {
    console.log('[debug] start ===> ', evt.detail)
    onStart(evt)
  })
  player.addEventListener('text', (evt) => {
    console.log('[debug] text ===> ', evt.detail)
    onText(evt)
  })
  player.addEventListener('setup', (evt) => {
    console.log('[debug] setup ===> ', evt.detail)
    onSetup(evt)
  })
  player.addEventListener('stats', (evt) => {
    console.log('[debug] stats ===> ', evt.detail)
    aggregateStats(evt.detail)
  })
}
