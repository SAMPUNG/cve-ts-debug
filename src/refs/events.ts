import { MessageType, WS_TAG } from '@cve-ts/dictionary'
import {
  emitUIInteraction,
  onResizePlayerStyle,
  send,
  ws,
} from '@cve-ts/player'
import type { UIDescriptor } from '@cve-ts/player'

import refs from './instance'
import { startLatencyTest } from '../core/latency'

export function setupHTMLEvents() {
  refs['overlay-button'].addEventListener('click', () => {
    refs['cve-player-debug-panel'].classList.toggle('overlay-shown')
  })

  refs['enlarge-display-to-fill-window-tgl'].onchange = () => {
    onResizePlayerStyle()
  }

  refs['quality-control-ownership-tgl'].onchange = () => {
    send(new Uint8Array([MessageType.RequestQualityControl]).buffer)
  }

  refs['encoder-params-submit'].onclick = () => {
    const rateControl = refs['encoder-rate-control'].value
    const targetBitrate =
      Number(refs['encoder-target-bitrate-text'].value) * 1000
    const maxBitrate = Number(refs['encoder-max-bitrate-text'].value) * 1000
    const minQP = refs['encoder-min-qp-text'].value
    const maxQP = refs['encoder-max-qp-text'].value
    const fillerData = refs['encoder-filler-data-tgl'].checked ? 1 : 0
    const multipass = refs['encoder-multipass'].value

    emitUIInteraction({
      Console: `PixelStreaming.Encoder.RateControl ${rateControl}`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.Encoder.TargetBitrate ${
        targetBitrate > 0 ? targetBitrate : -1
      }`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.Encoder.MaxBitrateVBR ${
        maxBitrate > 0 ? maxBitrate : -1
      }`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.Encoder.MinQP ${minQP}`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.Encoder.MaxQP ${maxQP}`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.Encoder.EnableFillerData ${fillerData}`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.Encoder.Multipass ${multipass}`,
    })
  }

  refs['webrtc-params-submit'].onclick = () => {
    const degradationPref = refs['webrtc-degradation-pref'].value
    const maxFPS = refs['webrtc-max-fps-text'].value
    const minBitrate = Number(refs['webrtc-min-bitrate-text'].value) * 1000
    const maxBitrate = Number(refs['webrtc-max-bitrate-text'].value) * 1000
    const lowQP = refs['webrtc-low-qp-text'].value
    const highQP = refs['webrtc-high-qp-text'].value

    emitUIInteraction({
      Console: `PixelStreaming.WebRTC.DegradationPreference ${degradationPref}`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.WebRTC.MaxFps ${maxFPS}`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.WebRTC.MinBitrate ${minBitrate}`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.WebRTC.MaxBitrate ${maxBitrate}`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.WebRTC.LowQpThreshold ${lowQP}`,
    })
    emitUIInteraction({
      Console: `PixelStreaming.WebRTC.HighQpThreshold ${highQP}`,
    })
  }

  refs['show-fps-button'].onclick = () => {
    const consoleDescriptor = {
      Console: 'stat fps',
    }
    emitUIInteraction(consoleDescriptor)
  }

  refs['match-viewport-res-tgl'].onchange = () => {
    onResizePlayerStyle()
  }

  refs['show-stats-tgl'].onchange = (event) => {
    const target = event.target as HTMLInputElement
    refs['stats-container'].style.display = target.checked ? 'block' : 'none'
  }

  refs['kick-other-players-button'].onclick = () => {
    console.log(...WS_TAG, '-> SS: kick')
    ws?.send(JSON.stringify({ type: 'kick' }))
  }

  refs['latency-test-button'].onclick = () => {
    startLatencyTest()
  }

  refs['debug-button'].onclick = () => {
    const Command = refs['debug-command'].value.trim()
    const Data = refs['debug-data'].value.trim()

    if (Command !== '') {
      const dataObject: UIDescriptor = { Command }
      if (Data.trim() !== '') {
        try {
          dataObject.Data = JSON.parse(Data)
        } catch (e) {
          dataObject.Data = Data
        }
      }
      emitUIInteraction(dataObject)
      refs['debug-response'].value = JSON.stringify(dataObject)
    }
  }
}
