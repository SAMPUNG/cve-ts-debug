import {
  ControlSchemeType,
  InputOptions,
} from '@cve-ts/dictionary'
import {
  wrapper,
  ws,
} from '@cve-ts/player'

let active: boolean = false
let closeTimeout: number = 10
let countdown: number = 0
let countdownTimer: NodeJS.Timer | undefined = undefined
let enabled: boolean = false
let overlay: HTMLElement | undefined = undefined
let warnTimeout: number = 120
let warnTimer: NodeJS.Timeout | undefined = undefined

export function hideOverlay() {
  setOverlay('hidden-state')
}

// If the user interacts then reset the warning timer.
export function resetAfkWarningTimer() {
  if (active) {
    clearTimeout(warnTimer)
    warnTimer = setTimeout(() => {
      showAfkOverlay()
    }, warnTimeout * 1000)
  }
}

export function setOverlay(
  htmlClass: string,
  htmlElement?: HTMLElement,
  onClickFunction?: (ev: MouseEvent) => void
) {
  let overlay = wrapper.querySelector<HTMLDivElement>('#video-play-overlay')
  if (!overlay) {
    overlay = document.createElement('div')
    overlay.id = 'video-play-overlay'
    overlay.style.display = 'none'
    wrapper.appendChild(overlay)
  }

  // Remove existing html child elements so we can add the new one
  while (overlay.lastChild) {
    overlay.removeChild(overlay.lastChild)
  }

  if (htmlElement) overlay.appendChild(htmlElement)

  if (onClickFunction) {
    overlay.addEventListener('click', function onOverlayClick(event: MouseEvent) {
      onClickFunction(event)
      overlay!.removeEventListener('click', onOverlayClick)
    })
  }

  // Remove existing html classes so we can set the new one
  const cl = overlay.classList
  for (let i = cl.length - 1; i >= 0; i--) {
    cl.remove(cl[i])
  }

  overlay.classList.add(htmlClass)
}

function showAfkOverlay() {
  // Pause the timer while the user is looking at the inactivity warning overlay.
  stopAfkWarningTimer()

  // Show the inactivity warning overlay.
  overlay = document.createElement('div')
  overlay.id = 'afk-overlay'
  setOverlay('clickable-state', overlay, () => {
    // The user clicked so start the timer again and carry on.
    hideOverlay()
    clearInterval(countdownTimer)
    startAfkWarningTimer()
  })

  countdown = closeTimeout
  updateAfkOverlayText()

  if (InputOptions.ControlScheme === ControlSchemeType.LockedMouse) {
    document.exitPointerLock()
  }

  countdownTimer = setInterval(() => {
    countdown -= 1
    if (countdown === 0) {
      // The user failed to click so disconnect them.
      hideOverlay()
      ws?.close()
    } else {
      // Update the countdown message.
      updateAfkOverlayText()
    }
  }, 1000)
}

// Start a timer which when elapsed will warn the user they are inactive.
export function startAfkWarningTimer() {
  active = enabled
  resetAfkWarningTimer()
}

// Stop the timer which when elapsed will warn the user they are inactive.
export function stopAfkWarningTimer() {
  active = false
}

export function updateAfkOverlayText() {
  if (overlay) {
    overlay.innerHTML = `<center>No activity detected<br>Disconnecting in ${countdown} seconds<br>Click to continue<br></center>`
  }
}
