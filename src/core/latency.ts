import { MessageType } from '@cve-ts/dictionary'
import { emitDescriptor } from '@cve-ts/player'

import refs from '../refs/instance'

let browserReceiptTimeMs: number | null = null
let frameDisplayDeltaTimeMs: number | null = null
let testStartTimeMs: number | null = null
let ueCaptureToSendMs: number | null = null
let ueEncodeMs: number | null = null
let uePostCaptureTimeMs: number | undefined
let uePostEncodeTimeMs: number | undefined
let uePreCaptureTimeMs: number | undefined
let uePreEncodeTimeMs: number | undefined
let ueReceiptTimeMs: number | null = null
let ueTransmissionTimeMs: number | null = null

function onAllLatencyTimingsReady() {
  if (!browserReceiptTimeMs) {
    return
  }

  let latencyExcludingDecode = browserReceiptTimeMs - testStartTimeMs!
  let uePixelStreamLatency =
    uePreEncodeTimeMs == 0 || uePreCaptureTimeMs == 0
      ? '???'
      : uePostEncodeTimeMs! - uePreCaptureTimeMs!
  let captureLatency = uePostCaptureTimeMs! - uePreCaptureTimeMs!
  let encodeLatency = uePostEncodeTimeMs! - uePreEncodeTimeMs!
  let ueLatency = ueTransmissionTimeMs! - ueReceiptTimeMs!
  let networkLatency = latencyExcludingDecode - ueLatency
  let browserSendLatency = latencyExcludingDecode - networkLatency - ueLatency

  //these ones depend on frameDisplayDeltaTimeMs
  let endToEndLatency = null
  let browserSideLatency = null

  if (frameDisplayDeltaTimeMs && browserReceiptTimeMs) {
    endToEndLatency = frameDisplayDeltaTimeMs + latencyExcludingDecode
    browserSideLatency = endToEndLatency - networkLatency - ueLatency
  }

  let latencyStatsInnerHTML = ''
  latencyStatsInnerHTML += `<div>Net latency RTT (ms): ${networkLatency}</div>`
  latencyStatsInnerHTML += `<div>UE Capture+Encode (ms): ${uePixelStreamLatency}</div>`
  latencyStatsInnerHTML += `<div>UE Capture (ms): ${captureLatency}</div>`
  latencyStatsInnerHTML += `<div>UE Encode (ms): ${encodeLatency}</div>`
  latencyStatsInnerHTML += `<div>Total UE latency (ms): ${ueLatency}</div>`
  latencyStatsInnerHTML += `<div>Browser send latency (ms): ${browserSendLatency}</div>`
  latencyStatsInnerHTML +=
    frameDisplayDeltaTimeMs && browserReceiptTimeMs
      ? `<div>Browser receive latency (ms): ${frameDisplayDeltaTimeMs}</div>`
      : ''
  latencyStatsInnerHTML += browserSideLatency
    ? `<div>Total browser latency (ms): ${browserSideLatency}</div>`
    : ''
  latencyStatsInnerHTML += `<div>Total latency (excluding browser) (ms): ${latencyExcludingDecode}</div>`
  latencyStatsInnerHTML += endToEndLatency
    ? `<div>Total latency (ms): ${endToEndLatency}</div>`
    : ''

  refs['latency-stats'].innerHTML = latencyStatsInnerHTML
}

function reset() {
  testStartTimeMs = null
  ueReceiptTimeMs = null
  ueEncodeMs = null
  ueCaptureToSendMs = null
  ueTransmissionTimeMs = null
  browserReceiptTimeMs = null
  frameDisplayDeltaTimeMs = null
}

export function setUETimings(ueTimings: UETimings) {
  ueReceiptTimeMs = ueTimings.ReceiptTimeMs
  ueEncodeMs = ueTimings.EncodeMs
  ueCaptureToSendMs = ueTimings.CaptureToSendMs
  ueTransmissionTimeMs = ueTimings.TransmissionTimeMs
  browserReceiptTimeMs = Date.now()

  onAllLatencyTimingsReady()
}

export function setFrameDisplayDeltaTime(deltaTimeMs: number) {
  if (frameDisplayDeltaTimeMs == null) {
    frameDisplayDeltaTimeMs = Math.round(deltaTimeMs)
    onAllLatencyTimingsReady()
  }
}

export function startLatencyTest() {
  reset()

  testStartTimeMs = Date.now()

  emitDescriptor(MessageType.LatencyTest, {
    StartTime: testStartTimeMs,
  })
}
